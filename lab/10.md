# Använda API med HttpClient

Målet med övningen är att du ska lära dig konsumera ett API på serversidan med HttpClient och HttpClientFactory.

För övningen ska vi använda ett öppet API [Trafiklab](https://www.trafiklab.se/).

## Trafiklab

Börja med att bekanta dig med de API:er du ska använda. Registrera ett konto och använd Postman för att experimentera med anropen.

* [Registrera ett konto](https://www.trafiklab.se/user/register) på Trafiklab.
* Klicka runt på sajten, undersök och testa vilka API:er du behöver använda för att kunna se när nästa buss går hemifrån dig. Tips! Du behöver två API:er, ett för att söka fram område och ett för att få avgångar i realtid för ett område.
* Skapa ett projekt för labben på Trafiklab, inkludera de API:er du behöver använda och skapa API-nycklar.
* Använd Postman för att testa anrop till API med dina data.

## HttpClient

Skapa ett nytt ASP.NET Core MVC projekt. 

Nu ska vi bygga tre vyer. På startsidan visas en textbox där man skriver in namnet på hållplatsen och en sök-knapp. När man söker visas en lista med hållplatser. Klickar man på en hållplats i listan ska en sida med kommande avgångar för den hållplatsen visas.

**OBS!** Lägg inte in några API-nycklar i källkoden eller *appsettings.json** för då riskerar du att bli avstängd om du publicerar projektet på t ex github. Förslagsvis högerklickar du på projektet och väljer *Manage User Secrets* så har du hemligheterna utanför källkodshanteringen fast du kan läsa in dem som om de låg i *appsettings.json*.

Börja med att registrera ```IHttpClientFactory``` som en tjänst i Startup.

```csharp
services.AddHttpClient();
```

Lägg in ```IHttpClientFactory clientFactory``` i din Controllers constructor.

Implementera API-anropet i en Action Metod i din Controller. (I verkliga projekt görs allt detta isolerat i Infrastructure-projektet och endast ett abstrakt interface för tjänsten finns i Application-projektet.)

```csharp
// Bygg Url för anrop
var urlBuilder = new UriBuilder("https://api.sl.se/api2/typeahead.json");
var query = HttpUtility.ParseQueryString(urlBuilder.Query);
query["key"] = configuration["api-key-typeahead"];
query["searchstring"] = q;
urlBuilder.Query = query.ToString();

// Konstruera Request utifrån Url och Http Headers.
var request = new HttpRequestMessage(HttpMethod.Get, urlBuilder.Uri);
request.Headers.Add("Accept", "application/json");
request.Headers.Add("User-Agent", "HttpClient");

// Skapa en HttpClient (som en webbläsare fast utan gränssnitt)
var client = clientFactory.CreateClient();

// Detta gör det externa anropet - alltid Async!
var response = await client.SendAsync(request);

if (response.IsSuccessStatusCode)
{
    result = await response.Content.ReadAsAsync<TypeAheadRoot>();
    // TODO: Handle result
}
// TODO: Handle error
```

För att skapa klasser för att deserialisera JSON-data kopierar du ett svar från Postman och använder en funktion i Visual Studio för att analysera resultatet och skapa klasser genom *Edit > Paste Special > Paste JSON as Classes*.

Skicka ut resultatet i en *ViewModel* och visa en lista med hållplatser som länkar till nästa sidan.

Implementera en vy och rendera lista med hållplatser.

Upprepa ovan men anropa API för *realtimedeparturesv4* för att visa nästa avgång.

## Nästa resa

Titta på API för *realtimedeparturesv4. Gör ett nytt gränssnitt som visar nästa resa från dig till skolan.
